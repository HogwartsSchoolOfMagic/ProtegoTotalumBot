name: CI

on:
  workflow_dispatch:
  #push:
  #  branches:
  #    - master
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  ktlint:
    name: âœ’ï¸ Ğ¡Ñ‚Ğ¸Ğ»ÑŒ ĞºĞ¾Ğ´Ğ°
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3
      - name: â˜•ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: "temurin"
          cache: 'gradle'
      - name: ğŸ”“ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹ Ğ½Ğ° gradlew
        run: chmod +x ./gradlew
      - name: âœ’ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ° Ñ Gradle
        run: ./gradlew ktlintCheck --no-daemon
  assemble:
    name: ğŸ§© Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
    needs: [ ktlint ]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3
      - name: â˜•ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: "temurin"
          cache: 'gradle'
      - name: ğŸ”“ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹ Ğ½Ğ° gradlew
        run: chmod +x ./gradlew
      - name: ğŸ§© Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ Gradle
        run: ./gradlew assemble --no-daemon
  sonar:
    name: ğŸ“ˆ SonarCloud
    needs: [ assemble ]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: â˜•ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: "temurin"
          cache: 'gradle'
      - name: ğŸ”“ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹ Ğ½Ğ° gradlew
        run: chmod +x ./gradlew
      - name: ğŸ“’ ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ SonarCloud
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: ğŸ“ˆ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ñ SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew build sonarqube --info